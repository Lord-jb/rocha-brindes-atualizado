---
import Layout from '@/layouts/Layout.astro';
import Header from '@/components/Header';
import Footer from '@/components/Footer';
import ProductCard from '@/components/ProductCard';
import ProductFilters from '@/components/ProductFilters';

// Get query parameters
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('search') || '';
const categorySlug = url.searchParams.get('category') || '';
const sortBy = url.searchParams.get('sort') || 'featured';
const page = parseInt(url.searchParams.get('page') || '1', 10);
const limit = 12;
const offset = (page - 1) * limit;

// Fetch categories
const categoriesUrl = new URL('/api/categories', Astro.url.origin);
const categoriesResponse = await fetch(categoriesUrl.toString());
const categories = await categoriesResponse.json();

// Build products query
const productsUrl = new URL('/api/products', Astro.url.origin);
if (searchQuery) productsUrl.searchParams.set('search', searchQuery);
if (categorySlug) productsUrl.searchParams.set('category', categorySlug);
productsUrl.searchParams.set('sort', sortBy);
productsUrl.searchParams.set('limit', limit.toString());
productsUrl.searchParams.set('offset', offset.toString());

const productsResponse = await fetch(productsUrl.toString());
const { products, total } = await productsResponse.json();

// Calculate pagination
const totalPages = Math.ceil(total / limit);
const hasNextPage = page < totalPages;
const hasPrevPage = page > 1;

// Find current category name
const currentCategory = categorySlug
  ? categories.find((cat: any) => cat.slug === categorySlug)
  : null;

const title = currentCategory
  ? `${currentCategory.name} - Rocha Brindes`
  : searchQuery
    ? `Busca: "${searchQuery}" - Rocha Brindes`
    : 'Catálogo de Produtos - Rocha Brindes';

const description = currentCategory
  ? `Explore nossa seleção de ${currentCategory.name.toLowerCase()} personalizados de alta qualidade.`
  : 'Explore nosso catálogo completo de brindes personalizados de alta qualidade para sua empresa.';
---

<Layout title={title} description={description}>
  <Header client:load />

  <main class="flex-1 py-8 md:py-12">
    <div class="container mx-auto px-4">

      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-display font-bold text-gray-900 mb-2">
          {currentCategory ? currentCategory.name : 'Catálogo de Produtos'}
        </h1>
        {searchQuery && (
          <p class="text-gray-600">
            Resultados para: <span class="font-medium text-gray-900">"{searchQuery}"</span>
          </p>
        )}
        <p class="text-gray-600 mt-1">
          {total} {total === 1 ? 'produto encontrado' : 'produtos encontrados'}
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 lg:gap-8">

        <!-- Filters Sidebar (Desktop) -->
        <aside class="hidden lg:block lg:col-span-1">
          <ProductFilters
            client:load
            categories={categories}
            currentCategory={categorySlug}
            currentSort={sortBy}
            searchQuery={searchQuery}
          />
        </aside>

        <!-- Products Grid -->
        <div class="lg:col-span-3">

          <!-- Mobile Filters Toggle -->
          <div class="lg:hidden mb-6">
            <ProductFilters
              client:load
              categories={categories}
              currentCategory={categorySlug}
              currentSort={sortBy}
              searchQuery={searchQuery}
              mobile={true}
            />
          </div>

          <!-- Products Grid -->
          {products.length > 0 ? (
            <div class="product-grid mb-8">
              {products.map((product: any) => (
                <div class="product-item">
                  <ProductCard client:visible product={product} />
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center py-16">
              <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <h3 class="text-xl font-medium text-gray-900 mb-2">Nenhum produto encontrado</h3>
              <p class="text-gray-600 mb-6">
                {searchQuery
                  ? 'Tente buscar com outros termos ou remova os filtros.'
                  : 'Não encontramos produtos nesta categoria no momento.'
                }
              </p>
              <a href="/loja" class="btn-primary">
                Ver Todos os Produtos
              </a>
            </div>
          )}

          <!-- Pagination -->
          {totalPages > 1 && (
            <div class="flex items-center justify-center gap-2 mt-8">
              {hasPrevPage ? (
                <a
                  href={`/loja?${new URLSearchParams({
                    ...(searchQuery && { search: searchQuery }),
                    ...(categorySlug && { category: categorySlug }),
                    ...(sortBy && { sort: sortBy }),
                    page: (page - 1).toString()
                  })}`}
                  class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Anterior
                </a>
              ) : (
                <span class="px-4 py-2 border border-gray-200 rounded-lg text-gray-400 cursor-not-allowed">
                  Anterior
                </span>
              )}

              <div class="flex items-center gap-2">
                {Array.from({ length: Math.min(totalPages, 5) }, (_, i) => {
                  let pageNum;
                  if (totalPages <= 5) {
                    pageNum = i + 1;
                  } else if (page <= 3) {
                    pageNum = i + 1;
                  } else if (page >= totalPages - 2) {
                    pageNum = totalPages - 4 + i;
                  } else {
                    pageNum = page - 2 + i;
                  }

                  const isCurrentPage = pageNum === page;

                  return (
                    <a
                      href={`/loja?${new URLSearchParams({
                        ...(searchQuery && { search: searchQuery }),
                        ...(categorySlug && { category: categorySlug }),
                        ...(sortBy && { sort: sortBy }),
                        page: pageNum.toString()
                      })}`}
                      class={`w-10 h-10 flex items-center justify-center rounded-lg transition-colors ${
                        isCurrentPage
                          ? 'bg-primary-500 text-white font-medium'
                          : 'border border-gray-300 hover:bg-gray-50'
                      }`}
                    >
                      {pageNum}
                    </a>
                  );
                })}
              </div>

              {hasNextPage ? (
                <a
                  href={`/loja?${new URLSearchParams({
                    ...(searchQuery && { search: searchQuery }),
                    ...(categorySlug && { category: categorySlug }),
                    ...(sortBy && { sort: sortBy }),
                    page: (page + 1).toString()
                  })}`}
                  class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  Próximo
                </a>
              ) : (
                <span class="px-4 py-2 border border-gray-200 rounded-lg text-gray-400 cursor-not-allowed">
                  Próximo
                </span>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  </main>

  <Footer client:load />

  <script>
    // Animate product items on load
    if (typeof gsap !== 'undefined') {
      gsap.from('.product-item', {
        opacity: 0,
        y: 30,
        duration: 0.5,
        stagger: 0.1,
        ease: 'power2.out'
      });
    }
  </script>
</Layout>

<style>
  .product-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (min-width: 640px) {
    .product-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
  }

  @media (min-width: 768px) {
    .product-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .product-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
